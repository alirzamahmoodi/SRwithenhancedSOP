# Speech-to-Text Transcription Module (`transcribe.py`)

## Purpose

This module is responsible for sending the extracted audio data to an external speech-to-text service (configured as Google Gemini in the current implementation) and processing the response to generate a structured text report.

## Class: `Transcribe`

*   Encapsulates the logic for interacting with the Google Gemini transcription API.
*   Initialized with the application `config` dictionary, configuring the API key and model name (`genai.configure`, `genai.GenerativeModel`).

## Helper Class: `Transcription(BaseModel)`

*   A `pydantic` model defining the expected structure of the JSON response from the Gemini API: `{\"Reading\": str, \"Conclusion\": str}`.
*   This schema is passed to the API call to enforce the output format.

## Main Method: `transcribe(self, dcm_path, audio_path)`

*   **Purpose:** Executes the transcription process using the Google Gemini API.
*   **Parameters:**
    *   `dcm_path` (str): Path to the original DICOM file (read to check validity before proceeding, but metadata not currently used in the prompt).
    *   `audio_path` (str): Path to the temporary WAV audio file generated by `extract_audio.py`.
*   **Returns:**
    *   `list`: A Python list containing a single dictionary that matches the `Transcription` pydantic model (e.g., `[{\"Reading\": \"...\", \"Conclusion\": \"...\"}]`) if successful.
    *   `None`: If any step fails (DICOM read, audio upload, API call, JSON parsing).
*   **Raises:**
    *   Logs various errors but aims to return `None` on failure rather than raising exceptions upwards. Handled errors include `FileNotFoundError`, `pydicom.errors.InvalidDicomError`, and various `google.api_core.exceptions` (like `Unauthenticated`, `DeadlineExceeded`, `ServiceUnavailable`, `GoogleAPIError`), and `json.JSONDecodeError`.
*   **Workflow:**
    1.  Reads the DICOM file (`dcm_path`) to ensure it's accessible and valid.
    2.  Uploads the audio file (`audio_path`) to the Gemini API using `genai.upload_file()`.
    3.  Constructs a detailed prompt instructing the AI model:
        *   To act as a medical transcriptionist.
        *   To output a single JSON object matching the `Transcription` schema (`{\"Reading\": \"...\", \"Conclusion\": \"...\"}`).
        *   To transcribe verbatim dictation into "Reading" (with length limit).
        *   To summarize findings from "Reading" into "Conclusion" (with length limit).
        *   To remove PHI, use English (translating relevant Persian terms), maintain professional tone, and exclude non-dictation content.
        *   To respond *only* with the JSON object, no preamble.
    4.  Calls `self.model.generate_content()` with the uploaded file and prompt, specifying `response_mime_type=\"application/json\"` and `response_schema=list[Transcription]` in the `GenerationConfig`.
    5.  Receives the `response` from the API.
    6.  Attempts to parse `response.text` using `json.loads()`.
    7.  If parsing is successful, returns the resulting Python list/dictionary.
    8.  If any step (DICOM read, upload, API call, JSON parse) fails, logs the error and returns `None`.

## Key Functionality

*   **Gemini API Integration:** Connects to, uploads audio to, and generates content from the Google Gemini API.
*   **API Credential Management:** Uses `GEMINI_API_KEY` from `config.yaml`.
*   **Structured Prompting:** Uses a detailed prompt to guide the AI towards the desired output format and content.
*   **JSON Output Enforcement:** Leverages Gemini's JSON mode and Pydantic schema (`response_schema`) to request structured output.
*   **Response Parsing & Validation:** Attempts to parse the JSON response and implicitly validates against the expected structure.

## Configuration Requirements (`config.yaml`)

Requires settings specific to the chosen AI service, for example:

```yaml
# ----------------- AI Services (Example: Gemini) -----------------
GEMINI_API_KEY: "your_api_key"
MODEL_NAME: "gemini-1.5-flash"
# Optional: Parameters controlling transcription behavior (e.g., temperature)
# transcription_temperature: 0.8
```

## Error Handling

*   Should handle API-specific errors (authentication, rate limits, timeouts, service unavailability).
*   May implement retry logic with backoff for transient network or API errors.

## Dependencies

*   `google-generativeai`: For Gemini API interaction.
*   `google-api-core`: For handling specific Google API exceptions.
*   `pydicom`: For reading the source DICOM file.
*   `pydantic`: For defining the response schema model.
*   `json`: For parsing the final JSON response from the API.
*   `logging`: For errors and progress.
*   `traceback`: For logging detailed error information.

## Integration

*   Called by `main.py` in the `run_pipeline` function after audio extraction.
*   Receives the temporary WAV file path from `extract_audio.py`.
*   The returned report text is passed to `database_operations.save_transcription` (for MongoDB) and potentially `store_transcribed_report.py` (for Oracle).

## Related Documents
- [System Architecture](../high_level/architecture.md)
- [Configuration Reference](../high_level/config_reference.md)
- [Audio Extraction Module](extract_audio.md)